<?php/*  ------------------------------------------------------------------------  Copyright (C) 2014 Bart Orriens, Albert Weerman  This library/program is free software; you can redistribute it and/or modify it under the terms of the GNU Lesser General Public License as published by the Free Software Foundation; either version 2.1 of the License, or (at your option) any later version.  This library is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more details.  You should have received a copy of the GNU Lesser General Public License along with this library; if not, write to the Free Software Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA  ------------------------------------------------------------------------ *//* HH GRID */function hhGrid($variables) {    $name = "hhGrid";    $contentStr = '';    $contentStr .= '<input type=hidden name=answer1 id=hiddengrid value="' . urlencode($answer) . '" />                    <input type=hidden name=gridfilled id=gridfilled value="1" />                    <input type="submit" id="form-foo-submit" style="display: none"/>';    $contentStr .= "<script type='text/javascript' src='js/datagrid/jquery.appendGrid.js'></script>                    <script type='text/javascript' src='js/jqueryui/jquery-ui.min.js'></script>";    $contentStr .= '<link rel="stylesheet" type="text/css" href="js/datagrid/jquery.appendGrid.css">                   <link rel="stylesheet" type="text/css" href="js/jqueryui/jquery-ui.bootstrap.css">';    $contentStr .= addGrid($variables, $name, "1", getCurrentHHMembers(1));//$contentStr .= "<script type='text/javascript'>alert('hhhhh');</script>";    $contentStr .= "<script type='text/javascript'>            // listen for submit            $('#form').submit(function(event) {                                if (hiddenclick == 1) {                //alert('done');                    return true;                }                                event.preventDefault();                event.stopPropagation();                                $('#" . $name . "').appendGrid('removeEmptyRows');                                var allData = $('#" . $name . "').appendGrid('getAllValue');                if (allData == '') {                    //alert('uhu');                    $('#gridfilled').val('2');                }                $('#hiddengrid').val(JSON.stringify(allData));                //alert(JSON.stringify(allData));                                                // now click the hidden submit (FF does not submit form if an input was removed from the form :(:)                // http://stackoverflow.com/questions/11582981/submit-fails-after-input-is-removed-from-form-in-firefox                hiddenclick = 1;                $('#form-foo-submit').click();                                return false;            });            ";    $contentStr .= "</script>";    return $contentStr;}function hhGridChanged($variables) {    $name = "hhGrid";    $contentStr = '';    $contentStr .= '<input type=hidden name=answer1 id=hiddengrid value="' . urlencode($answer) . '" />                    <input type="submit" id="form-foo-submit" style="display: none"/>';    $contentStr .= "<script type='text/javascript' src='js/datagrid/jquery.appendGrid.js'></script>                    <script type='text/javascript' src='js/jqueryui/jquery-ui.min.js'></script>";    $contentStr .= '<link rel="stylesheet" type="text/css" href="js/datagrid/jquery.appendGrid.css">                   <link rel="stylesheet" type="text/css" href="js/jqueryui/jquery-ui.bootstrap.css">';    $contentStr .= addGrid($variables, $name, "2", getCurrentHHMembers(2));    $contentStr .= "<script type='text/javascript'>            // listen for submit            $('#form').submit(function(event) {                                if (hiddenclick == 1) {                //alert('done');                    return true;                }                $('#" . $name . "').appendGrid('removeEmptyRows');                                var allData = $('#" . $name . "').appendGrid('getAllValue');                $('#hiddengrid').val(JSON.stringify(allData));                //alert(JSON.stringify(allData));                                event.preventDefault();                event.stopPropagation();                                // now click the hidden submit (FF does not submit form if an input was removed from the form :(:)                // http://stackoverflow.com/questions/11582981/submit-fails-after-input-is-removed-from-form-in-firefox                hiddenclick = 1;                $('#form-foo-submit').click();                                return false;            });                        ";    $contentStr .= "</script>";    $contentStr .= '<script src="js/bootstrap-select/bootstrap-select-min.js"></script>';    $contentStr .= '<link href="css/bootstrap-select.css" type="text/css" rel="stylesheet">';    return $contentStr;}function hhGridExisting($variables) {    $contentStr = '';    $contentStr .= addGrid($variables, "hhGridExisting", "3", getCurrentHHMembers(3));    return $contentStr;}function hhGridNew($variables) {    $name = "hhGrid";    $contentStr = '';    $contentStr .= '<input type=hidden name=answer2 id=hiddengrid value="' . urlencode($answer) . '" />                    <input type="submit" id="form-foo-submit" style="display: none"/>';    $contentStr .= "<script type='text/javascript' src='js/datagrid/jquery.appendGrid.js'></script>                    <script type='text/javascript' src='js/jqueryui/jquery-ui.min.js'></script>";    $contentStr .= '<link rel="stylesheet" type="text/css" href="js/datagrid/jquery.appendGrid.css">                   <link rel="stylesheet" type="text/css" href="js/jqueryui/jquery-ui.bootstrap.css">';    $contentStr .= addGrid($variables, $name, "1", getNewHHMembers());    $contentStr .= "<script type='text/javascript'>            // listen for submit            $('#form').submit(function(event) {                                if (hiddenclick == 1) {                //alert('done');                    return true;                }                $('#" . $name . "').appendGrid('removeEmptyRows');                                var allData = $('#" . $name . "').appendGrid('getAllValue');                $('#hiddengrid').val(JSON.stringify(allData));                //alert(JSON.stringify(allData));                                event.preventDefault();                event.stopPropagation();                                // now click the hidden submit (FF does not submit form if an input was removed from the form :(:)                // http://stackoverflow.com/questions/11582981/submit-fails-after-input-is-removed-from-form-in-firefox                hiddenclick = 1;                $('#form-foo-submit').click();                                return false;            });                        ";    $contentStr .= "</script>";    $contentStr .= '<script src="js/bootstrap-select/bootstrap-select.js"></script>';    $contentStr .= '<link href="css/bootstrap-select.css" type="text/css" rel="stylesheet">';    return $contentStr;}function getNewHHMembers() {    // declare    $initdata = array();    // get enegine    global $engine;    // get new hhmember number    $current = $engine->getAnswer("hhmembernumber");    $new = $engine->getAnswer("newhhmembernumber");    // we have hhmembers!    if ($new > 0) {        // get info        $active = $engine->getAnswer("hhmemberactive");        $first = $engine->getAnswer("hhmemberfirstname");        $last = $engine->getAnswer("hhmemberlastname");        $gender = $engine->getAnswer("hhmembergender");        $day = $engine->getAnswer("hhmemberdateofbirth_day");        $month = $engine->getAnswer("hhmemberdateofbirth_month");        $year = $engine->getAnswer("hhmemberdateofbirth_year");        $relation = $engine->getAnswer("hhmemberrelationship");        // only return new HH members!!        for ($i = ($current + 1); $i <= ($current + $new); $i++) {            if ($active[$i] == 1) {                $g = $gender[$i];                if ($g == "") {                    $g = "0";                }                $d = $day[$i];                if ($d == "") {                    $d = "0";                }                $m = $month[$i];                if ($m == "") {                    $m = "0";                }                $y = $year[$i];                if ($y == "") {                    $y = "0";                }                $r = $relation[$i];                if ($r == "") {                    $r = "0";                }                $initdata[] = "{ 'hhmemberfirstname': \"" . $first[$i] . "\", 'hhmemberlastname': \"" . $last[$i] . "\", 'hhmembergender': " . $g . ", 'hhmemberbirthday': " . $d . ", 'hhmemberbirthmonth': " . $m . ", 'hhmemberbirthyear': " . $y . ", 'hhmemberrelationship': " . $r . ", 'hhmemberindex': " . $i . "}";            }        }    }    // return array;    return $initdata;}function getCurrentHHMembers($type) {    // declare    $initdata = array();    // get enegine    global $engine;    // get hhmember number    $number = $engine->getAnswer("hhmembernumber");    // we have hhmembers!    if ($number > 0) {        // get info        $active = $engine->getAnswer("hhmemberactive");        $first = $engine->getAnswer("hhmemberfirstname");        $last = $engine->getAnswer("hhmemberlastname");        $gender = $engine->getAnswer("hhmembergender");        $day = $engine->getAnswer("hhmemberdateofbirth_day");        $month = $engine->getAnswer("hhmemberdateofbirth_month");        $year = $engine->getAnswer("hhmemberdateofbirth_year");        $relation = $engine->getAnswer("hhmemberrelationship");        if (trim($type) == "2") {            $changed = $engine->getAnswer("hhmemberchanged");        }        //print_R($day);        for ($i = 1; $i <= $number; $i++) {            if ($active[$i] == 1) {                $extra = "";                if (trim($type) == "2") {                    $c = $changed[$i];                    if ($c == "") {                        $c = "4";                    }                    $extra = ", 'hhmemberchanged': " . $c;                }                $g = $gender[$i];                if ($g == "") {                    $g = "0";                }                $d = $day[$i];                if ($d == "") {                    $d = "0";                }                $m = $month[$i];                if ($m == "") {                    $m = "0";                }                $y = $year[$i];                if ($y == "") {                    $y = "0";                }                $r = $relation[$i];                if ($r == "") {                    $r = "0";                }                $initdata[] = "{ 'hhmemberfirstname': \"" . $first[$i] . "\", 'hhmemberlastname': \"" . $last[$i] . "\", 'hhmembergender': " . $g . ", 'hhmemberbirthday': " . $d . ", 'hhmemberbirthmonth': " . $m . ", 'hhmemberbirthyear': " . $y . ", 'hhmemberrelationship': " . $r . $extra . ", 'hhmemberindex': " . $i . "}";            }        }    }    // return array;    return $initdata;}function addGrid($variables, $name = "hhGrid", $type = "", $initdata = array()) {    // uses jquery plugin: http://appendgrid.apphb.com    global $engine;    $display = $engine->getDisplayObject();    //$initdata = array();            $cnt = sizeof($initdata);    // changing screen or showing existing in add new screen    if (trim($type) == "2" || $type == "3") {        $extraattr = ", disabled: 'disabled'";        $extraattr2 = "disabled: 'disabled'";    }    $var = $engine->getVariableDescriptive("hhmembergender");    $options = $var->getOptions();    $genderoptstr = array();    $genderoptstr[] = "0: '" . Language::labelDropdownNothing() . "'";    foreach ($options as $option) {        $genderoptstr[] = $option["code"] . ": '" . $option["label"] . "'";    }    $gender = implode(", ", $genderoptstr);    $var = $engine->getVariableDescriptive("hhmemberrelationship");    $options = $var->getOptions();    $optstr = array();    $optstr[] = "0: '" . Language::labelDropdownNothing() . "'";    foreach ($options as $option) {        $optstr[] = $option["code"] . ": '" . $option["label"] . "'";    }    $rel = implode(", ", $optstr);    $var = $engine->getVariableDescriptive("hhmemberdateofbirth_day");    $options = $var->getOptions();    $days = array();    $days[] = "0: '" . Language::labelDropdownNothing() . "'";    foreach ($options as $option) {        $days[] = $option["code"] . ": '" . $option["label"] . "'";    }    $birthday = implode(", ", $days);    $var = $engine->getVariableDescriptive("hhmemberdateofbirth_month");    $options = $var->getOptions();    $months = array();    $months[] = "0: '" . Language::labelDropdownNothing() . "'";    foreach ($options as $option) {        $months[] = $option["code"] . ": '" . $option["label"] . "'";    }    $birthmonth = implode(", ", $months);    $var = $engine->getVariableDescriptive("hhmemberdateofbirth_year");    $options = $var->getOptions();    $years = array();    $years[] = "0: '" . Language::labelDropdownNothing() . "'";    foreach ($options as $option) {        $years[] = $option["code"] . ": '" . $option["label"] . "'";    }    $birthyear = implode(", ", $years);    // english    $l = getSurveyLanguage();    if ($l == 1) {        $labels = array(            'hhmemberfirstname' => 'First name',            'hhmemberlastname' => 'Last name',            'hhmembergender' => 'Gender',            'hhmemberbirthmonth' => 'Month of birth',            'hhmemberbirthday' => 'Day of birth',            'hhmemberbirthyear' => 'Year of birth',            'hhmemberrelationship' => 'Relationship to person'        );        $buttonlabels = array(            'append' => 'Add person',            'removeLast' => 'Remove last person'        );        $buttontitles = array(            'append' => 'Add person',            'removeLast' => 'Remove last person'        );        $messages = array(            'rowEmpty' => 'No persons listed',            'insert' => 'Add person above current row',            'remove' => 'Remove this person',            'rowEmpty' => 'No persons listed'        );    }    // spanish    else if ($l == 2) {        $labels = array(            'hhmemberfirstname' => 'First name',            'hhmemberlastname' => 'Last name',            'hhmembergender' => 'Gender',            'hhmemberbirthmonth' => 'Month of birth',            'hhmemberbirthday' => 'Day of birth',            'hhmemberbirthyear' => 'Year of birth',            'hhmemberrelationship' => 'Relationship to person'        );        $buttonlabels = array(            'append' => 'Add person',            'removeLast' => 'Remove last person'        );        $buttontitles = array(            'append' => 'Add person',            'removeLast' => 'Remove last person'        );        $messages = array(            'rowEmpty' => 'No persons listed',            'insert' => 'Add person above current row',            'remove' => 'Remove this person',            'rowEmpty' => 'No persons listed'        );    }    $contentStr = '';    $contentStr .= '<table id="' . $name . '">                    </table>';    $contentStr .= "<script type='text/javascript'>                var hhmembercnt = $cnt;        var hiddenclick = 0;       $(function () {            // Initialize appendGrid            $('#" . $name . "').appendGrid({                                i18n: {                    rowEmpty: '" . $messages["rowEmpty"] . "',                    insert: '" . $messages["insert"] . "',                    remove: '" . $messages["remove"] . "',                    //moveUp: 'Move this person up',                    //moveDown: 'Move this person down'                },                initRows: 1,                afterRowInserted: function (caller, parentRowIndex, addedRowIndex) {                                        fixBootstrap" . $name . "();                                        //enableInputMask(addedRowIndex);                                  },                  afterRowAppended: function (caller, parentRowIndex, addedRowIndex) {                                        fixBootstrap" . $name . "();                                        //enableInputMask(addedRowIndex);                                  },                  columns: [                        { name: 'hhmemberfirstname', display: '" . $labels["hhmemberfirstname"] . "', type: 'text', ctrlAttr: { autocomplete: 'off' $extraattr }, ctrlCss: { width: '100px'}, emptyCriteria: function (value) {                                return (value == '');                                    } },                        { name: 'hhmemberlastname', display: '" . $labels["hhmemberlastname"] . "', type: 'text', ctrlAttr: { autocomplete: 'off' $extraattr }, ctrlCss: { width: '100px'}, emptyCriteria: function (value) {                                return (value == '');                                    } },                        { name: 'hhmembergender', display: '" . $labels["hhmembergender"] . "', type: 'select', ctrlOptions: { " . $gender . " }, ctrlCss: { width: '100px' }, ctrlAttr: { $extraattr2 }, emptyCriteria: function (value) {                                return (value == 0);                            } },                        { name: 'hhmemberbirthmonth', display: '" . $labels["hhmemberbirthmonth"] . "', type: 'select', ctrlOptions: { " . $birthmonth . " }, ctrlAttr: { $extraattr2 }, emptyCriteria: function (value) {                                return (value == 0);                            } },                            { name: 'hhmemberbirthday', display: '" . $labels["hhmemberbirthday"] . "', type: 'select', ctrlOptions: { " . $birthday . " }, ctrlAttr: { $extraattr2 }, emptyCriteria: function (value) {                                return (value == 0);                            } },                        { name: 'hhmemberbirthyear', display: '" . $labels["hhmemberbirthyear"] . "', type: 'select', ctrlOptions: { " . $birthyear . " }, ctrlAttr: { $extraattr2 }, emptyCriteria: function (value) {                                return (value == 0);                            } },                        { name: 'hhmemberrelationship', display: '" . $labels["hhmemberrelationship"] . "', type: 'select', ctrlOptions: { " . $rel . " }, ctrlAttr: { $extraattr2 }, emptyCriteria: function (value) {                                return (value == 0);                            } },";    // add changed dropdown    if (trim($type) == "2") {        $changed = array();        $changed[] = "0: 'No change'";        $var = $engine->getVariableDescriptive("hhmemberchanged");        $options = $var->getOptions();        foreach ($options as $option) {            $changed[] = $option["code"] . ": '" . $option["label"] . "'";        }        $changed = implode(", ", $changed);        $contentStr .= "{ name: 'hhmemberchanged', display: 'Changed?', type: 'select', ctrlOptions: { " . $changed . " } },";    }    $contentStr .= "{ name: 'hhmemberindex', type: 'hidden' }                        ],                                customGridButtons: {                    //insert: $('<button class=\"btn btn-default\"><span class=\"glyphicon glyphicon-plus\"></button>').get(0),";    if (trim($type) == "1") {        $contentStr .= "\r\nremove: $('<button class=\"btn btn-default\"><span class=\"glyphicon glyphicon-remove\"></button>').get(0),";    }    $contentStr .= "//moveUp: $('<button class=\"btn btn-default\"><span class=\"glyphicon glyphicon-arrow-up\"></button>').get(0),                    //moveDown: $('<button class=\"btn btn-default\"><span class=\"glyphicon glyphicon-arrow-down\"></button>').get(0),                            },                hideButtons: {                    moveUp: true,                    moveDown: true,";    // no remove for change or show existing    if (trim($type) == "2" || $type == "3") {        $contentStr .= "remove: true,";        $contentStr .= "removeLast: true,";        $contentStr .= "append: true,";    }    $contentStr .= "insert: true                },                initData: [                    " . implode(",", $initdata) . "                ]              });                        // no rows yet, so we don't call fixBootstrap in an event handler            if ($cnt == 0) {                fixBootstrap" . $name . "();            }";    if (trim($type) == "1") {        $contentStr .= "            $('#" . $name . "_hhmemberrelationship_td_head').each(function() {                $(this).append('" . $engine->getAnswer("FLRelationshipHelp") . "');            });                $('#" . $name . "_hhmemberrelationship_td_head a[data-toggle=\"popover\"]').popover(            {               trigger: 'focus',               html: true,               placement: 'auto',               content: function() {                return $('#relationship_wrapper').html();              }            });";    }    $contentStr .= "                    // refresh            $('.selectpicker').selectpicker('refresh');                    });                   function fixBootstrap" . $name . "() {            // change table            $( 'table' ).each(function() {                $(this).removeClass();                $(this).addClass('table table-striped table-bordered');            });            // change textboxes to bootstrap            $( 'table input:text' ).each(function() {                $(this).addClass('form-control uscic-form-control');            });                        // add selectpicker to dropdowns            $( 'table select' ).each(function() {                $(this).addClass('selectpicker show-tick');            });                        // remove unwanted button classes            //$( 'table button.moveUp' ).each(function() {            //    $(this).removeClass('moveUp');            //});                        //$( 'table button.moveDown' ).each(function() {            //    $(this).removeClass('moveDown');            //});                        //$( 'table button.insert' ).each(function() {            //    $(this).removeClass('insert');            //});                        $( 'table button.remove' ).each(function() {                $(this).removeClass('remove');            });                        $( 'table button.append' ).each(function() {                $(this).addClass('btn btn-default');                $(this).removeClass('append');                $(this).html('" . $buttonlabels["append"] . "');                $(this).attr('title', '" . $buttontitles["append"] . "');            });                        $( 'table button.removeLast' ).each(function() {                $(this).addClass('btn btn-default');                $(this).removeClass('removeLast');                $(this).html('" . $buttonlabels["removeLast"] . "');                $(this).attr('title', '" . $buttontitles["removeLast"] . "');            });                        // update drop downs            if( /Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent) ) {                $(\"table .selectpicker\").selectpicker('mobile');            }            else {                $(\"table .selectpicker\").selectpicker();            }";    if (trim($type) == "1") {        $contentStr .= "                        // adjust drop down display            $('button[data-id^=\"" . $name . "_hhmembergender_\"]').css('min-width', '100px').css('width', '105px').css('max-width', '105px');                        $('button[data-id^=\"" . $name . "_hhmembergender_\"]').parent().css('min-width', '105px').css('width', '105px').css('max-width', '105px');            $('button[data-id^=\"" . $name . "_hhmembergender_\"]').parent().parent().css('min-width', '125px').css('width', '125px').css('max-width', '125px');            $('button[data-id^=\"" . $name . "_hhmemberbirthday_\"]').css('min-width', '90px').css('width', '90px').css('max-width', '90px');            $('button[data-id^=\"" . $name . "_hhmemberbirthday_\"]').parent().css('min-width', '90px').css('width', '90px').css('max-width', '90px');            $('button[data-id^=\"" . $name . "_hhmemberbirthday_\"]').parent().parent().css('min-width', '110px').css('width', '110px').css('max-width', '110px');            $('button[data-id^=\"" . $name . "_hhmemberbirthmonth_\"]').css('min-width', '110px').css('width', '110px').css('max-width', '110px');            $('button[data-id^=\"" . $name . "_hhmemberbirthmonth_\"]').parent().css('min-width', '110px').css('width', '110px').css('max-width', '110px');            $('button[data-id^=\"" . $name . "_hhmemberbirthmonth_\"]').parent().parent().css('min-width', '130px').css('width', '130px').css('max-width', '130px');                        $('button[data-id^=\"" . $name . "_hhmemberbirthyear_\"]').css('min-width', '90px').css('width', '90px').css('max-width', '90px');            $('button[data-id^=\"" . $name . "_hhmemberbirthyear_\"]').parent().css('min-width', '90px').css('width', '90px').css('max-width', '90px');            $('button[data-id^=\"" . $name . "_hhmemberbirthyear_\"]').parent().parent().css('min-width', '110px').css('width', '110px').css('max-width', '110px');                        $('button[data-id^=\"" . $name . "_hhmemberrelationship_\"]').css('min-width', '240px').css('width', '240px').css('max-width', '240px');                         $('button[data-id^=\"" . $name . "_hhmemberrelationship_\"]').parent().css('min-width', '240px').css('width', '240px').css('max-width', '240px');             $('button[data-id^=\"" . $name . "_hhmemberrelationship_\"]').parent().parent().css('min-width', '260px').css('width', '260px').css('max-width', '260px');                        // adjust first name/last name columns            $('input[id^=\"" . $name . "_hhmemberfirstname_\"]').css('min-width', '90px').css('width', '90px').css('max-width', '90px');                        $('td[id^=\"" . $name . "_hhmemberfirstname_td_\"]').css('min-width', '110px').css('width', '110px').css('max-width', '110px');                                    $('input[id^=\"" . $name . "_hhmemberlastname_\"]').css('min-width', '90px').css('width', '90px').css('max-width', '90px');                        $('td[id^=\"" . $name . "_hhmemberlastname_td_\"]').css('min-width', '110px').css('width', '110px').css('max-width', '110px');                                    // adjust number column            $('tr[id^=\"" . $name . "_Row_\"]').children().first().css('min-width', '25px').css('width', '25px').css('max-width', '25px').css('vertical-align', 'middle');";    } else if (trim($type) == "2" || $type == "3") {        $contentStr .= "                        // adjust drop down display            $('button[data-id^=\"" . $name . "_hhmembergender_\"]').css('min-width', '105px').css('width', '105px').css('max-width', '105px');                        $('button[data-id^=\"" . $name . "_hhmembergender_\"]').parent().css('min-width', '105px').css('width', '105px').css('max-width', '105px');            $('button[data-id^=\"" . $name . "_hhmembergender_\"]').parent().parent().css('min-width', '115px').css('width', '115px').css('max-width', '115px');            $('button[data-id^=\"" . $name . "_hhmemberbirthday_\"]').css('min-width', '90px').css('width', '90px').css('max-width', '90px');            $('button[data-id^=\"" . $name . "_hhmemberbirthday_\"]').parent().css('min-width', '90px').css('width', '90px').css('max-width', '90px');            $('button[data-id^=\"" . $name . "_hhmemberbirthday_\"]').parent().parent().css('min-width', '100px').css('width', '100px').css('max-width', '100px');            $('button[data-id^=\"" . $name . "_hhmemberbirthmonth_\"]').css('min-width', '110px').css('width', '110px').css('max-width', '110px');            $('button[data-id^=\"" . $name . "_hhmemberbirthmonth_\"]').parent().css('min-width', '110px').css('width', '110px').css('max-width', '110px');            $('button[data-id^=\"" . $name . "_hhmemberbirthmonth_\"]').parent().parent().css('min-width', '120px').css('width', '120px').css('max-width', '120px');                        $('button[data-id^=\"" . $name . "_hhmemberbirthyear_\"]').css('min-width', '90px').css('width', '90px').css('max-width', '90px');            $('button[data-id^=\"" . $name . "_hhmemberbirthyear_\"]').parent().css('min-width', '90px').css('width', '90px').css('max-width', '90px');            $('button[data-id^=\"" . $name . "_hhmemberbirthyear_\"]').parent().parent().css('min-width', '100px').css('width', '100px').css('max-width', '100px');                        $('button[data-id^=\"" . $name . "_hhmemberrelationship_\"]').css('min-width', '210px').css('width', '210px').css('max-width', '210px');                         $('button[data-id^=\"" . $name . "_hhmemberrelationship_\"]').parent().css('min-width', '210px').css('width', '210px').css('max-width', '210px');             $('button[data-id^=\"" . $name . "_hhmemberrelationship_\"]').parent().parent().css('min-width', '210px').css('width', '210px').css('max-width', '210px');                        // adjust first name/last name columns            $('input[id^=\"" . $name . "_hhmemberfirstname_\"]').css('min-width', '90px').css('width', '90px').css('max-width', '90px');                        $('td[id^=\"" . $name . "_hhmemberfirstname_td_\"]').css('min-width', '100px').css('width', '100px').css('max-width', '100px');                                    $('input[id^=\"" . $name . "_hhmemberlastname_\"]').css('min-width', '90px').css('width', '90px').css('max-width', '90px');                        $('td[id^=\"" . $name . "_hhmemberlastname_td_\"]').css('min-width', '100px').css('width', '100px').css('max-width', '100px');                                    // adjust number column            $('tr[id^=\"" . $name . "_Row_\"]').children().first().css('min-width', '25px').css('width', '25px').css('max-width', '25px').css('vertical-align', 'middle');            $('button[data-id^=\"" . $name . "_hhmemberchanged_\"]').css('min-width', '125px').css('width', '125px').css('max-width', '125px');                        $('button[data-id^=\"" . $name . "_hhmemberchanged_\"]').parent().css('min-width', '125px').css('width', '125px').css('max-width', '125px');            $('button[data-id^=\"" . $name . "_hhmemberchanged_\"]').parent().parent().css('min-width', '130px').css('width', '130px').css('max-width', '130px');                        ";    }    $contentStr .= "    }    </script>";    /* usable for input masking     *      *                         { name: 'hhmemberbirthmonth', display: 'Birth month', type: 'select', ctrlOptions: { " . $birthmonth . " }, ctrlCss: { width: '50px' }, ctrlAttr: { 'data-inputmask': '\'alias\': \'integer\', \'autoUnmask\': \'true\', \'removeMaskOnSubmit\': \'true\'' }, emptyCriteria: function (value) {      return (value == 0);      } },     * function enableInputMask(row) {      return;      var index = $('#hhGrid').appendGrid('getUniqueIndex', row);      if (index <= $cnt) {      return;      }      //alert(index);      // input masking      if(inputMaskingSupported() === true){      $('#hhGrid_hhmemberage_' + index).inputmask();      }      }     *      */    return $contentStr;}/* PICTURE *//* PICTURE */function takePicture($variablename, $primkey = 'test'){   global $engine;   //$primkey = 'test';   if ($engine != null){     $primkey = $engine->getPrimaryKey();   }   $contentStr = '';   $contentStr .= "<script type='text/javascript' src='js/mootools-core-1.4.5-nocompat.js'></script>"; //<button id="upload" onclick="upload()">Upload</button>   $contentStr .= '<table><tr><td valign=top><video id="video"></video></td><td valign=center><button id="startbutton" class="btn btn-default">Take photo</button></td><td valign=top><photo id="photo"></photo></td><td valign=top><canvas id="canvas"></canvas></td><td valign=top> <img src="custom/picture/index.php?id=' . $primkey . '&fieldname=' . $variablename . '&p=show" width="200"></td></tr></table><script type=\'text/javascript\'>//<![CDATA[ (function() {  var streaming = false,      video        = document.querySelector(\'#video\'),      cover        = document.querySelector(\'#cover\'),      canvas       = document.querySelector(\'#canvas\'),      photo        = document.querySelector(\'#photo\'),      startbutton  = document.querySelector(\'#startbutton\'),      width = 200,      height = 0;  navigator.getMedia = ( navigator.getUserMedia ||                          navigator.webkitGetUserMedia ||                         navigator.mozGetUserMedia ||                         navigator.msGetUserMedia);  navigator.getMedia(    {       video: true,       audio: false     },    function(stream) {      if (navigator.mozGetUserMedia) {         video.mozSrcObject = stream;      } else {        var vendorURL = window.URL || window.webkitURL;        video.src = vendorURL ? vendorURL.createObjectURL(stream) : stream;      }      video.play();    },    function(err) {      console.log("An error occured! " + err);    }  );  video.addEventListener(\'canplay\', function(ev){    if (!streaming) {      height = video.videoHeight / (video.videoWidth/width);      video.setAttribute(\'width\', width);      video.setAttribute(\'height\', height);      canvas.setAttribute(\'width\', width);      canvas.setAttribute(\'height\', height);      streaming = true;    }  }, false);  function takepicture() {    canvas.width = width;    canvas.height = height;    canvas.getContext(\'2d\').drawImage(video, 0, 0, width, height);    var data = canvas.toDataURL(\'image/png\');    photo.setAttribute(\'src\', data);    upload();  }  startbutton.addEventListener(\'click\', function(ev){      takepicture();    ev.preventDefault();  }, false);})();  var API_KEY = \'eb18642b5b220484864483b8e21386c3\';  function upload() {    var head = /^data:image\/(png|jpg);base64,/,        fd = new FormData(),toSend,        xhr = new XMLHttpRequest(),        links = \'\',        data = \'\';    setstate(\'uploading\');    data = (\'mozGetAsFile\' in canvas) ?           canvas.mozGetAsFile(\'webcam.png\') :           canvas.toDataURL(\'image/png\').replace(head, \'\');    fd.append(\'image\', data);    xhr.open(\'POST\', \'custom/picture/index.php?id=' . $primkey . '&fieldname=' . $variablename . '\');    xhr.addEventListener(\'error\', function(ev) {      console.log(\'Upload Error :\');    }, false);    xhr.addEventListener(\'load\', function(ev) {    }, false);    xhr.send(fd);  }  function setstate(newstate) {    state = newstate;    document.body.className = newstate;    } //]]>  </script>';   return $contentStr;}function takeBarCode(){  global $engine;    $primkey = 'test';  if ($engine != null){    $primkey = $engine->getPrimaryKey();  }  $returnStr = '';  $returnStr .= '<link rel="stylesheet" href="css/example.css">';  if ($primkey == 'test'){    $returnStr .= '<input type=text name=resultcode id=resultcode>';    $returnStr .= '<div class="controls"><button class=stop>Stop</button></div>';  }  else {    $returnStr .= '<input type=hidden name=resultcode id=resultcode>';  }  $returnStr .= '<div id="interactive" class="viewport"></div>';//  $returnStr .= '<script src="js/jquery-1.11.0.min.js"></script>';  $returnStr .= '<script src="js/quagga.min.js" type="text/javascript"></script>';  $returnStr .= '<script src="js/live_w_locator.js" type="text/javascript"></script>';  return $returnStr;}function takeBarCode2(){  global $engine;    $primkey = 'test';  if ($engine != null){    $primkey = $engine->getPrimaryKey();  }  $contentStr = '';  $contentStr .= '<script type="text/javascript" src="js/DecoderWorker.js"></script>';    $contentStr .= '<table><tr><td valign=top>  <video id="video"></video></td><td valign=middle align=center width="200px">  <button id="startbuttonq" class="btn btn-default">Start scanning</button><br/><p id="textbit" style="font-family:arial;color:red;font-size:18px;">Press "Start scanning"</p>  </td><td valign=top>  <canvas id="canvas"></canvas></td></tr>  </table>	<script type="text/javascript"> $(document).ready(function(){                           // $("#answer2").val("noscan");                            $("#answer2").attr("readonly", "readonly"); //if empty: dont allow to go back or next       if ($("#answer2").val() == ""){          $("#uscic-backbutton").prop("disabled", "disabled");          $("#uscic-nextbutton").prop("disabled", "disabled");        }                                                 });  (function() {var scanInterval;  $("#startbuttonq").click(function(){//alert("hhhh");      $("#startbuttonq").prop("value", "Scanning..");      $("#startbuttonq").prop("disabled", "disabled");      $("#uscic-backbutton").prop("disabled", "disabled");      $("#uscic-nextbutton").prop("disabled", "disabled");      $("#answer2").val("noscan");     scanInterval = setInterval(function() {  takepicture();}, 3000);return false;  });	  var streaming = false,      Result       = document.querySelector("#textbit"),      video        = document.querySelector("#video"),      canvas       = document.querySelector("#canvas"),      photo        = document.querySelector("#photo"),      startbutton  = document.querySelector("#startbutton"),      width = 200,      height = 175;    var scanNumbers = 0;  navigator.getMedia = ( navigator.getUserMedia ||                         navigator.webkitGetUserMedia ||                         navigator.mozGetUserMedia ||                         navigator.msGetUserMedia);  navigator.getMedia(    {      video: true,      audio: false    },    function(stream) {      if (navigator.mozGetUserMedia) {        video.mozSrcObject = stream;      } else {        var vendorURL = window.URL || window.webkitURL;        video.src = vendorURL.createObjectURL(stream);      }      video.play();    },    function(err) {      console.log("An error occured! " + err);    }  );  video.addEventListener(\'canplay\', function(ev){    if (!streaming) {      //height = video.videoHeight / (video.videoWidth/width);      video.setAttribute(\'width\', width);      video.setAttribute(\'height\', height);      canvas.setAttribute(\'width\', width);      canvas.setAttribute(\'height\', height);      streaming = true;    }  }, false);  function takepicture() {    scanNumbers++;    console.log("hooray");    canvas.width = width;    canvas.height = height;    canvas.getContext(\'2d\').drawImage(video, 0, 0, width, height);   	var data = canvas.toDataURL(\'image/png\');  	var resultArray = [];    console.log("data set");			ctx = canvas.getContext(\'2d\');			var workerCount = 0;			function receiveMessage(e) {    console.log("message received");console.log(e.data.success);				if(e.data.success === "log") {					console.log(e.data.result);					return;				}				workerCount--;				if(e.data.success){					var tempArray = e.data.result;                                        var r1stcode = "";					for(var i = 0; i < tempArray.length; i++) {						if(resultArray.indexOf(tempArray[i]) == -1) {							resultArray.push(tempArray[i]);                                                    if (r1stcode == ""){                                                      r1stcode = tempArray[i];                                                    }						}					}					Result.innerHTML=resultArray.join("<br />") + "<br />Done! Press next";		                        $("#answer2").val(r1stcode.replace("Code39: ", "").replace("*",""));clearInterval(scanInterval);      $("#uscic-backbutton").prop("disabled", false);      $("#uscic-nextbutton").prop("disabled", false);//alert("match");				}else{					if(resultArray.length === 0 && workerCount === 0) {						Result.innerHTML= "Try: " + (scanNumbers) + " Decoding failed.";					}				}				if (scanNumbers > 10){				      clearInterval(scanInterval);				      Result.innerHTML="Could not scan barcode please enter manually!";				$("#answer2").val("timeout");      $("#uscic-backbutton").prop("disabled", false);      $("#uscic-nextbutton").prop("disabled", false);                           }			}			var DecodeWorker = new Worker("js/DecoderWorker.js");			var RightWorker = new Worker("js/DecoderWorker.js");			var LeftWorker = new Worker("js/DecoderWorker.js");			var FlipWorker = new Worker("js/DecoderWorker.js");			DecodeWorker.onmessage = receiveMessage;			RightWorker.onmessage = receiveMessage;			LeftWorker.onmessage = receiveMessage;			FlipWorker.onmessage = receiveMessage;   	        DecodeBar();   			function DecodeBar(){         processImage();							}   function processImage() {  					resultArray = [];					workerCount = 4;					Result.innerHTML="";					DecodeWorker.postMessage({pixels: ctx.getImageData(0,0,canvas.width,canvas.height).data, width: canvas.width, height: canvas.height, cmd: "normal"});					RightWorker.postMessage({pixels: ctx.getImageData(0,0,canvas.width,canvas.height).data, width: canvas.width, height: canvas.height, cmd: "right"});					LeftWorker.postMessage({pixels: ctx.getImageData(0,0,canvas.width,canvas.height).data, width: canvas.width, height: canvas.height, cmd: "left"});					FlipWorker.postMessage({pixels: ctx.getImageData(0,0,canvas.width,canvas.height).data, width: canvas.width, height: canvas.height, cmd: "flip"});  }    }//}})();		</script>';  return $contentStr;}/* CUSTOM UAS3 */function customAnswerTypeInvestmentChoice($variablename) {    global $engine;    $displaynumbers = $engine->getDisplayNumbers();    $inputname = SESSION_PARAMS_ANSWER . $displaynumbers[strtoupper($variablename)];    $inputname2 = SESSION_PARAMS_ANSWER . $displaynumbers[strtoupper("log_" . $variablename)];    $index = substr($variablename, strpos($variablename, '['));    $contentStr = '';    $numberofbars = getFromSurvey('bars' . $index, 2);    $prices = array(0, getFromSurvey('price_A' . $index, 0), getFromSurvey('price_B' . $index, 0), getFromSurvey('price_C' . $index, 0), getFromSurvey('price_D' . $index, 0), getFromSurvey('price_E' . $index, 0));    $payoutheads = array(0, getFromSurvey('payout_heads_A' . $index, 0), getFromSurvey('payout_heads_B' . $index, 0), getFromSurvey('payout_heads_C' . $index, 0), getFromSurvey('payout_heads_D' . $index, 0), getFromSurvey('payout_heads_E' . $index, 0));    $payouttails = array(0, getFromSurvey('payout_tails_A' . $index, 0), getFromSurvey('payout_tails_B' . $index, 0), getFromSurvey('payout_tails_C' . $index, 0), getFromSurvey('payout_tails_D' . $index, 0), getFromSurvey('payout_tails_E' . $index, 0));    $moneyinhand = getFromSurvey('endowment' . $index, 0);    $defaultBarH = array(0, getFromSurvey('default_A' . $index, 0) * 2, getFromSurvey('default_B' . $index, 0) * 2, getFromSurvey('default_C' . $index, 0) * 2, getFromSurvey('default_D' . $index, 0) * 2, getFromSurvey('default_E' . $index, 0) * 2);    $choice = substr(substr($index, 1), 0, -1);    $arm1 = getFromSurvey('treatment_arm_1' . $index, 0);    $arm2 = getFromSurvey('treatment_arm_2' . $index, 0);    $arm3 = getFromSurvey('treatment_arm_3' . $index, 0);    $arm4 = getFromSurvey('treatment_arm_4' . $index, 0);    $investreceive = false;    if ($arm2 == 1 || $arm4 == 1) {        $investreceive = true;    }    $outside_option = getFromSurvey('outside_option' . $index, 0);    $formStr = "<input type=hidden id=answerq name='" . $inputname . "' value=''>\n";    $formStr .= "<input type=hidden id=logq name='" . $inputname2 . "' value=''>\n";    $contentStr = $formStr;    $contentStr .= '<table width=100% border=0></tr><td align=center ><table width=800px border=0><tr><td><div id=canvas><div style="height:170px" style="background:#CCCCCC"><table class="gridtable2" cellspacing=8 style="border-spacing: 18px 8px;"><tr><td style="width:65px"></td><td bgcolor=#4f984f align=center style="width:100px"><b>A</b></td><td bgcolor=red align=center style="width:100px"><b>B</b></td>';    if ($numberofbars > 2) {        $contentStr .= '<td bgcolor=blue align=center style="width:100px"><b>C</b></td>';    } else {        $contentStr .= '<td style="width:100px"></td>';    }    if ($numberofbars > 3) {        $contentStr .= '<td bgcolor=orange align=center style="width:100px"><b>D</b></td>';    } else {        $contentStr .= '<td style="width:100px"></td>';    }    if ($numberofbars > 4) {        $contentStr .= '<td bgcolor=#a09494 align=center style="width:100px"><b>E</b></td>';    } else {        $contentStr .= '<td style="width:100px"></td>';    }    $contentStr .= '</tr>';    $contentStr .= '<tr><td><i>Prices</i></td><td align=center>$' . number_format($prices[1], 2) . '</td><td align=center>$' . number_format($prices[2], 2) . '</td>';    if ($numberofbars > 2) {        $contentStr .= '<td align=center>$' . number_format($prices[3], 2) . '</td>';    } else {        $contentStr .= '<td></td>';    }    if ($numberofbars > 3) {        $contentStr .= '<td align=center>$' . number_format($prices[4], 2) . '</td>';    } else {        $contentStr .= '<td></td>';    }    if ($numberofbars > 4) {        $contentStr .= '<td align=center>$' . number_format($prices[5], 2) . '</td>';    } else {        $contentStr .= '<td></td>';    }    $contentStr .= '</tr>';    $contentStr .= '<tr><td><i>Payouts</i></td><td colspan=5></td></tr>';    $contentStr .= '<tr><td align=center>Heads</td><td align=center>$' . number_format($payoutheads[1], 2) . '</td><td align=center>$' . number_format($payoutheads[2], 2) . '</td>';    if ($numberofbars > 2) {        $contentStr .= '<td align=center>$' . number_format($payoutheads[3], 2) . '</td>';    } else {        $contentStr .= '<td></td>';    }    if ($numberofbars > 3) {        $contentStr .= '<td align=center>$' . number_format($payoutheads[4], 2) . '</td>';    } else {        $contentStr .= '<td></td>';    }    if ($numberofbars > 4) {        $contentStr .= '<td align=center>$' . number_format($payoutheads[5], 2) . '</td>';    } else {        $contentStr .= '<td></td>';    }    $contentStr .= '</tr>';    $contentStr .= '<tr><td align=center>Tails</td><td align=center>$' . number_format($payouttails[1], 2) . '</td><td align=center>$' . number_format($payouttails[2], 2) . '</td>';    if ($numberofbars > 2) {        $contentStr .= '<td align=center>$' . number_format($payouttails[3], 2) . '</td>';    } else {        $contentStr .= '<td></td>';    }    if ($numberofbars > 3) {        $contentStr .= '<td align=center>$' . number_format($payouttails[4], 2) . '</td>';    } else {        $contentStr .= '<td></td>';    }    if ($numberofbars > 4) {        $contentStr .= '<td align=center>$' . number_format($payouttails[5], 2) . '</td>';    } else {        $contentStr .= '<td></td>';    }    $contentStr .= '</tr>';//var prices = [0, 0.50, 1, 0.75, 0.60, 0.95];    $contentStr .= '<tr><td colspan=7><hr>';    $height = 15;    if ($investreceive) {        $height = 15;    }//style="height:' . $height . 'px"    $contentStr .= '<table border=0 cellspacing=0 cellpadding=0><tr><td align=left valign=bottom><div style="vertical-align:text-bottom; border-width:0px; height:19px"><font color=blue style="font-size: 14px;"><b>You have <font color=red style="font-size: 14px;">$' . $moneyinhand . '</font> to invest.';    $contentStr .= '</div></td><td valign=bottom>';    $dispnone = '';    if ($investreceive) {        //prefer!        $contentStr .= '<div id=prefer1 style="vertical-align:text-bottom; border-width:0px; height:19px"> ';        $contentStr .= '<font color=blue style="font-size: 14px;"><b>&nbsp;Do you prefer to: </div></td><td><div id=prefer2 valign=middle>';        $contentStr .= '<input type=button  value="Invest $' . $moneyinhand . '" onclick="unhidebars();"/>';        $contentStr .= '<input type=button  value="Receive $' . $outside_option . '" onclick="$(\'#answerq\').val(\'receive\'); document.getElementById(\'uscic-nextbutton\').click();" />';        $contentStr .= '</b></font></div>';        //  $contentStr .= '<div id=extratext style="display: none; border-width:0px;"><font color=blue style="font-size: 14px;"><b>How many shares of each asset do you want to buy?</b></div>';//    $dispnone = 'display: none; ';        $dispnone = 'display: none; pointer-events:none;';        $contentStr .= '<script>$(document).ready(function(){  jQuery(\'#main\').fadeTo(500, 0);  jQuery(\'#button\').fadeTo(500, 0);  jQuery(\'#bars\').fadeTo(500, 0);  jQuery(\'#howmanyshares\').fadeTo(500, 0);});</script>';    } else {        $contentStr .= '<div valign=middle style="border-width:0px; display:none"> ';        $contentStr .= '<font color=blue style="font-size: 14px;"><b>&nbsp;Do you prefer to: </div></td><td><div valign=middle style=" height:22px;">';        $contentStr .= '</b></font></div><script></script>';//      $contentStr .= '</td><td><div><font color=blue style="font-size: 14px;"><b>How many shares of each asset do you want to buy?</b></div>';//      $contentStr .= '<script>' . "\n";//			$contentStr .= 'document.getElementById("bars").style.display = "block";' . "\n";//			$contentStr .= 'document.getElementById("main").style.display = "block";' . "\n";//			$contentStr .= 'document.getElementById("button").style.display = "block";' . "\n";//			$contentStr .= '</script>' . "\n";    }    $contentStr .= '</td></tr></table>';    $contentStr .= '<div id=howmanyshares style="' . $dispnone . '"><font color=blue style="font-size: 14px;"><b>How many shares of each asset do you want to buy?</b></div>';    $contentStr .= '</td></tr></table>';    $contentStr .= '<div id=main style="' . $dispnone . '">';    $contentStr .= '<table border=0 class="gridtable2" cellspacing=8 style="padding-top: 0px; border-spacing: 18px 1px;"><tr><td style="padding-top: 0px;" colspan=7 align=center><br/></td></tr><tr><td style="width:65px">Shares</td><td align=center style="width:100px"><div id=\'sharesA\'></div></td><td align=center style="width:100px"><div id=\'sharesB\'></div></td>';    if ($numberofbars > 2) {        $contentStr .= "<td align=center style=\"width:100px\"><div id='sharesC'></div></td>";    } else {        $contentStr .= '<td style="width:100px"></td>';    }    if ($numberofbars > 3) {        $contentStr .= "<td align=center style=\"width:100px\"><div id='sharesD'></div></td>";    } else {        $contentStr .= '<td style="width:100px"></td>';    }    if ($numberofbars > 4) {        $contentStr .= "<td align=center style=\"width:100px\"><div id='sharesE'></div></td>";    } else {        $contentStr .= '<td style="width:100px"></td>';    }    $contentStr .= "</tr>";    $contentStr .= '</table><div id=bars name=bars style="' . $dispnone . 'position: relative; height:441px; width:740px; background-image: url(./custom/graph_50.jpg);">';    $contentStr .= '<div style="position: absolute; top: 29px; left:65px;">';    $contentStr .= '<div id=bar1 name=bar1 style="position: absolute; top: 200px; left:40px; height:300px; width:100px; background-color:#4f984f;"></div><div id=bar2 name=bar2 style="position: absolute; top: 300px; left:160px; height:150px; width:100px; background-color:red;"></div>';    if ($numberofbars > 2) {        $contentStr .= '<div id=bar3 name=bar3 style="position: absolute; top: 350px; left:280px; height:50px; width:100px; background-color:blue;"></div>';    } else {        $contentStr .= '<div id=bar3 name=bar3 style="display: none; position: absolute; top: 350px; left:280px; height:50px; width:100px; background-color:blue;"></div>';    }    if ($numberofbars > 3) {        $contentStr .= '<div id=bar4 name=bar4 style="position: absolute; top: 350px; left:400px; height:50px; width:100px; background-color:orange;"></div>';    } else {        $contentStr .= '<div id=bar4 name=bar4 style="display: none; position: absolute; top: 350px; left:400px; height:50px; width:100px; background-color:orange;"></div>';    }    if ($numberofbars > 4) {        $contentStr .= '<div id=bar5 name=bar5 style="position: absolute; top: 350px; left:520px; height:50px; width:100px; background-color:#a09494;"></div>';    } else {        $contentStr .= '<div id=bar5 name=bar5 style="display: none; position: absolute; top: 350px; left:520px; height:50px; width:100px; background-color:#a09494;"></div>';    }    $contentStr .= '</div><div id=buttons name=buttons style="position: relative; top:441px; height:20px; left:85px;"><div style="position: absolute; top: 0px; left:25px; height:20px; width:100px;"><input  type=button value="+" onclick="setButtonTops(1, 1);" style="width:35px"> <b>A</b> <input  type=button value="-" onclick="setButtonTops(1, -1);" style="width:35px"></div><div style="position: absolute; top: 0px; left:145px; height:20px; width:100px;"><input  type=button value="+" onclick="setButtonTops(2, 1);" style="width:35px"> <b>B</b> <input  type=button value="-" onclick="setButtonTops(2, -1);" style="width:35px"></div> ';    if ($numberofbars > 2) {        $contentStr .= '<div style="position: absolute; top: 0px; left:265px; height:20px; width:100px;"><input  type=button value="+" onclick="setButtonTops(3, 1);" style="width:35px"> <b>C</b> <input  type=button value="-" onclick="setButtonTops(3, -1);" style="width:35px"></div>';    } else {        $contentStr .= '<div style="display: none; position: absolute; top: 0px; left:265px; height:20px; width:100px;"><input  type=button value="+" onclick="setButtonTops(3, 1);" style="width:35px"> <b>C</b> <input  type=button value="-" onclick="setButtonTops(3, -1);" style="width:35px"></div>';    }    if ($numberofbars > 3) {        $contentStr .= '<div style="position: absolute; top: 0px; left:385px; height:20px; width:100px;"><input  type=button value="+" onclick="setButtonTops(4, 1);" style="width:35px"> <b>D</b> <input  type=button value="-" onclick="setButtonTops(4, -1);" style="width:35px"></div>';    } else {        $contentStr .= '<div style="display: none; position: absolute; top: 0px; left:385px; height:20px; width:100px;"><input  type=button value="+" onclick="setButtonTops(4, 1);" style="width:35px"> <b>D</b> <input  type=button value="-" onclick="setButtonTops(4, -1);" style="width:35px"></div>';    }    if ($numberofbars > 4) {        $contentStr .= '<div style="position: absolute; top: 0px; left:505px; height:20px; width:100px;"><input  type=button value="+" onclick="setButtonTops(5, 1);" style="width:35px"> <b>E</b> <input  type=button value="-" onclick="setButtonTops(5, -1);" style="width:35px"></div>';    } else {        $contentStr .= '<div style="display: none; position: absolute; top: 0px; left:505px; height:20px; width:100px;"><input  type=button value="+" onclick="setButtonTops(5, 1);" style="width:35px"> <b>E</b> <input  type=button value="-" onclick="setButtonTops(5, -1);" style="width:35px"></div>';    }    $contentStr .= '</div></div></div><br/><br/><br/><center><b><span id="de" style="display:none;">Decision #' . $choice . '</span></b><br/><br/>';    /* $contentStr .= '<div id=button style="' . $dispnone . '">';      $contentStr .= $nextButton;      $contentStr .= '</div>';      $contentStr .= '<br/><br/>';      //$contentStr .= '<img src="https://mmic.rand.org/panel/RALP_logo.gif" alt="American Life Panel" width="293" height="164">'; */    $contentStr .= '<script type=text/javascript>                        $( document ).ready(function() {                        ';    if ($investreceive) {        $contentStr .= '$( "#uscic-mainbody" ).css("height", "800px");';        $contentStr .= '$( "#uscic-nextbutton" ).hide();                            $( "#uscic-buttonpanel" ).hide();';    } else {        $contentStr .= '$( "#uscic-nextbutton" ).show();                            $( "#uscic-buttonpanel" ).show();';        $contentStr .= '$( "#uscic-mainbody" ).css("height", "800px");';    }    $contentStr .= '$( "#de" ).show();';    $contentStr .= '})                     </script>                    </center><div style="display:none"><table class="gridtable2" cellspacing=8 style="border-spacing: 18px 8px;"><tr><td style="width:65px"></td><td bgcolor=#4f984f align=center style="width:100px"><b>A</b></td><td bgcolor=red align=center style="width:100px"><b>B</b></td><td bgcolor=blue align=center style="width:100px"><b>C</b></td><td align=center style="width:100px"></td><td align=center style="width:100px"><b></b></td></tr><tr><td><i>Return</i></td><td align=center></td><td align=center></td><td align=center></td><td align=center><b>Total</b></td><td align=center></td></tr><tr><td colspan=7></td></tr><tr><td align=center>Heads</td><td align=center><div id=\'payoutheadsA\'></div></td><td align=center><div id=\'payoutheadsB\'></div></td><td align=center><div id=\'payoutheadsC\'></div></td><td align=center><div id=\'payoutheadsTotal\'></div><div id=\'payoutheadsD\'></div></td><td align=center><div id=\'payoutheadsE\'></div></td></tr><tr><td align=center>Tails</td><td align=center><div id=\'payouttailsA\'></div></td><td align=center><div id=\'payouttailsB\'></div></td><td align=center><div id=\'payouttailsC\'></div></td><td align=center><div id=\'payouttailsTotal\'></div><div id=\'payouttailsD\'></div></td><td align=center><div id=\'payouttailsE\'></div></td></tr></table></div></td></tr></table></td></tr></table><script>var log = "";';    $contentStr .= 'function unhidebars(){';//onclick="jQuery(\'#dataentry\').fadeTo(500, 1); document.getElementById(\'dataentry\').style.pointerEvents = \'auto\';"//$contentStr .= '$( "#bars" ).fadeIn( "slow");';//$contentStr .= '$( "#main" ).fadeIn( "slow");';    $contentStr .= '$( "#uscic-nextbutton" ).fadeTo(500, 1); document.getElementById(\'uscic-nextbutton\').style.pointerEvents = \'auto\';';    $contentStr .= '$( "#main" ).fadeTo(500, 1); document.getElementById(\'main\').style.pointerEvents = \'auto\';';    $contentStr .= '$( "#bars" ).fadeTo(500, 1); document.getElementById(\'bars\').style.pointerEvents = \'auto\';';    $contentStr .= '$( "#howmanyshares" ).fadeTo(500, 1); document.getElementById(\'bars\').style.pointerEvents = \'auto\';';//$contentStr .= 'document.getElementById("bars").style.display = "block";';//$contentStr .= 'document.getElementById("main").style.display = "block";';    $contentStr .= '$("#uscic-buttonpanel").show();';    $contentStr .= '$("#uscic-nextbutton").show();';    $contentStr .= '$("#uscic-mainbody").css("height", "800px");';    //$contentStr .= 'document.getElementById("uscic-nextbutton").style.display = "block";';        $contentStr .= '$( "#prefer1" ).fadeTo(500, 0);';    $contentStr .= '$( "#prefer2" ).fadeTo(500, 0);';    $contentStr .= '$( "#prefer1" ).css( "pointer-events", "none" );';    $contentStr .= '$( "#prefer2" ).css( "pointer-events", "none" );';//$contentStr .= '$( "#prefer1" ).hide( "slow");';//$contentStr .= '$( "#prefer2" ).hide( "slow");';    //$contentStr .= 'document.getElementById("extratext").style.display = "inline";alert("hhh"); ';//$contentStr .= 'document.getElementById("prefer1").style.display = "none";';//$contentStr .= 'document.getElementById("prefer2").style.display = "none";';    $contentStr .= '}';    $contentStr .= 'var bartops = [0, ' . $defaultBarH[1] . ',' . $defaultBarH[2] . ',' . $defaultBarH[3] . ',' . $defaultBarH[4] . ',' . $defaultBarH[5] . '];';    $contentStr .= 'var moneyinhand = ' . $moneyinhand . ';';    $contentStr .= 'var payoutheads = [0, ' . $payoutheads[1] . ',' . $payoutheads[2] . ',' . $payoutheads[3] . ',' . $payoutheads[4] . ',' . $payoutheads[5] . '];';    $contentStr .= 'var payouttails = [0, ' . $payouttails[1] . ',' . $payouttails[2] . ',' . $payouttails[3] . ',' . $payouttails[4] . ',' . $payouttails[5] . '];';    $contentStr .= 'var prices = [0, ' . $prices[1] . ',' . $prices[2] . ',' . $prices[3] . ',' . $prices[4] . ',' . $prices[5] . '];';    $contentStr .= 'var barmax = [0, moneyinhand/prices[1]*2, moneyinhand/prices[2]*2, moneyinhand/prices[3]*2, moneyinhand/prices[4]*2, moneyinhand/prices[5]*2];';    $contentStr .= "var topbars = 223;if ($.browser.mozilla){  topbars = 143;}var currentbar = 0;var stepbuttons = 4;var originalbar = 0;var barnumber = $numberofbars;function log(text, reset){  if (!reset){    document.getElementById('log').innerHTML= document.getElementById('log').innerHTML + \"----\" + text;  }  else {    document.getElementById('log').innerHTML= \"----\" + text;  }}function removeFromBar(bar, diff, orig, direction){//  log(\"diff\" + diff);//  log(\"prices\" + (prices[orig]/prices[bar]));    diff = diff * prices[orig]/prices[bar];  var othbart = diff;  var extra = 0;    if (bartops[bar] + othbart < 0){     extra = extra + (bartops[bar] + othbart) ;    bartops[bar] = 0;   }  else {/*    if (bartops[bar] + othbart > barmax[bar]){      extra = extra + (othbart - barmax[bar] - bartops[bar]);      bartops[bar] = barmax[bar];    }    else {      bartops[bar] = bartops[bar] + othbart;    }*/    bartops[bar] = bartops[bar] + othbart;  }  if (extra != 0){    //note!!! what if bar > 5??    if (direction == 1 && bar + 1 > barnumber){      direction = 0;    }    if (direction > 0){      extra = extra * (prices[bar] / prices[orig]);      removeFromBar(bar + 1, extra, orig, 1);    }    else {      // bar on the other side!      direction--;      extra = extra * (prices[bar] / prices[orig]);      removeFromBar(orig + direction, extra, orig, direction);    }  }//end calc division}function setButtonTops(bar, diff){  //alert(diff + \":\" + bartops[bar]);  if (diff < 0 && bartops[bar] <= 0){     setNewTops(bar, 0);  }  else if (diff > 0 && bartops[bar] >= barmax[bar]){     setNewTops(bar, barmax[bar]);  }  else if (bartops[bar] + diff < 0){     setNewTops(bar, 0);//    setNewTops(bar, 0 - bartops[bar] + diff);  }  else if (bartops[bar] + diff > barmax[bar]){     setNewTops(bar, barmax[bar]);//    setNewTops(bar, 100 - bartops[bar] + diff);  }  else {    setNewTops(bar, bartops[bar] + diff);  }}function setNewTops(bar, top){  $('#logq').val($('#logq').val() + \"!~!\" + bar + \"~\" + top);//  alert(bar + \":\" + top);  var oldtop = bartops[bar];  var diff = oldtop - top;  if (top < 0){ top = 0; diff = 0; }  if (diff < 0) { //moved up    if (bar != barnumber){      removeFromBar(bar + 1, (diff), bar, 1);    }    else {      removeFromBar(bar-1, (diff), bar, 0);    }  }  else {     if (bar != barnumber){      bartops[bar + 1] = bartops[bar + 1] + (diff * prices[bar]/prices[bar+1]);    }    else {      bartops[bar - 1] = bartops[bar - 1] + (diff * prices[bar]/prices[bar-1]);    }    if (bartops[bar + 1] > barmax[bar + 1]){       bartops[bar + 1] = barmax[bar + 1];     }    if (bartops[bar - 1] > barmax[bar - 1]){       bartops[bar - 1] = barmax[bar - 1];     }/*    var othbart = diff / 4;    bartops[1] = bartops[1] + othbart;		bartops[2] = bartops[2] + othbart;		bartops[3] = bartops[3] + othbart;		bartops[4] = bartops[4] + othbart;		bartops[5] = bartops[5] + othbart;*/  }  bartops[bar] = top;//  alert(bartops[1] + ':' + bartops[2]+ ':' + bartops[3]+ ':' + bartops[4]+ ':' + bartops[5]);  showBars();}function setCurrentBar(bar){  currentbar = bar;  $('#bars').css( 'cursor', 'n-resize' );}$( '#bar1' ).mousedown(function() {  setCurrentBar(1);});$( '#bar2' ).mousedown(function() {  setCurrentBar(2);});$( '#bar3' ).mousedown(function() {  setCurrentBar(3);});$( '#bar4' ).mousedown(function() {  setCurrentBar(4);});$( '#bar5' ).mousedown(function() {  setCurrentBar(5);});function showBarAsCents(amount){  return (Math.round(amount)/100).toFixed( 2 );}function showBarAsThousands(amount){  return (amount).toFixed( 3 );}function showBarAsDollars(amount){  return (amount * 100).toFixed( 2 );}function showBars(){  $('#bar1').css('top', 400 - (bartops[1] * 4));  $('#bar1').css('height', 400 - (400 - (bartops[1] * 4))); //400 - (bartops[1]) * 4);//  $('#t_amount1').val(showBarAsCents(bartops[1]));  $('#bar2').css('top', 400 - (bartops[2] * 4));  $('#bar2').css('height', 400 - (400 - (bartops[2] * 4))); //400 - (bartops[1]) * 4);//  $('#t_amount2').val(showBarAsCents(bartops[2]));  $('#bar3').css('top', 400 - (bartops[3] * 4));  $('#bar3').css('height', 400 - (400 - (bartops[3] * 4))); //400 - (bartops[1]) * 4);//  $('#t_amount3').val(showBarAsCents(bartops[3]));  $('#bar4').css('top', 400 - (bartops[4] * 4));  $('#bar4').css('height', 400 - (400 - (bartops[4] * 4))); //400 - (bartops[1]) * 4);//  $('#t_amount4').val(showBarAsCents(bartops[4]));  $('#bar5').css('top', 400 - (bartops[5] * 4));  $('#bar5').css('height', 400 - (400 - (bartops[5] * 4))); //400 - (bartops[1]) * 4);//  $('#t_amount5').val(showBarAsCents(bartops[5]));  $('#t_amounttotal').val(showBarAsCents(bartops[1] + bartops[2] + bartops[3] + bartops[4] + bartops[5]));  $('#sharesA').text(showBarAsDollars((bartops[1]/barmax[1])/prices[1] * moneyinhand / 100));  $('#sharesB').text(showBarAsDollars((bartops[2]/barmax[2])/prices[2] * moneyinhand / 100));  $('#sharesC').text(showBarAsDollars((bartops[3]/barmax[3])/prices[3] * moneyinhand / 100));  $('#sharesD').text(showBarAsDollars((bartops[4]/barmax[4])/prices[4] * moneyinhand / 100));  $('#sharesE').text(showBarAsDollars((bartops[5]/barmax[5])/prices[5] * moneyinhand / 100));  var answertext = showBarAsDollars((bartops[1]/barmax[1])/prices[1] * moneyinhand / 100) + \"~\" +                    showBarAsDollars((bartops[2]/barmax[2])/prices[2] * moneyinhand / 100) + \"~\" +                    showBarAsDollars((bartops[3]/barmax[3])/prices[3] * moneyinhand / 100)  + \"~\" +                    showBarAsDollars((bartops[4]/barmax[4])/prices[4] * moneyinhand / 100) + \"~\" +                    showBarAsDollars((bartops[5]/barmax[5])/prices[5] * moneyinhand / 100);  $('#answerq').val(answertext);  $('#logq').val($('#logq').val() + \"!~!\" + answertext);  //alert($('#answerq').val());  var totalAmount =  (((bartops[1]/barmax[1])/prices[1] * moneyinhand) * prices[1]) +(((bartops[2]/barmax[2])/prices[2] * moneyinhand) * prices[2]) +(((bartops[3]/barmax[3])/prices[3] * moneyinhand) * prices[3]) +(((bartops[4]/barmax[4])/prices[4] * moneyinhand) * prices[4]) +(((bartops[5]/barmax[5])/prices[5] * moneyinhand) * prices[5]);  //alert(totalAmount);  var amountHA = ((bartops[1]/barmax[1])/prices[1]) * payoutheads[1];  var amountTA = ((bartops[1]/barmax[1])/prices[1]) * payouttails[1];  var amountHB = ((bartops[2]/barmax[2])/prices[2]) * payoutheads[2];  var amountTB = ((bartops[2]/barmax[2])/prices[2]) * payouttails[2];  var amountHC = ((bartops[3]/barmax[3])/prices[3]) * payoutheads[3];  var amountTC = ((bartops[3]/barmax[3])/prices[3]) * payouttails[3];  var amountHD = ((bartops[4]/barmax[4])/prices[4]) * payoutheads[4];  var amountTD = ((bartops[4]/barmax[4])/prices[4]) * payouttails[4];  var amountHE = ((bartops[5]/barmax[5])/prices[5]) * payoutheads[5];  var amountTE = ((bartops[5]/barmax[5])/prices[5]) * payouttails[5];  $('#payoutheadsA').text('$' + showBarAsDollars(amountHA) );  $('#payouttailsA').text('$' + showBarAsDollars(amountTA) );  $('#payoutheadsB').text('$' + showBarAsDollars(amountHB) );  $('#payouttailsB').text('$' + showBarAsDollars(amountTB) );  $('#payoutheadsC').text('$' + showBarAsDollars(amountHC) );  $('#payouttailsC').text('$' + showBarAsDollars(amountTC) );  $('#payoutheadsD').text('$' + showBarAsDollars(amountHD) );  $('#payouttailsD').text('$' + showBarAsDollars(amountTD) );  $('#payoutheadsE').text('$' + showBarAsDollars(amountHE) );  $('#payouttailsE').text('$' + showBarAsDollars(amountTE) );  $('#payoutheadsTotal').text('$' + showBarAsDollars(amountHA + amountHB + amountHC /*+ amountHD + amountHE*/) );  $('#payouttailsTotal').text('$' + showBarAsDollars(amountTA + amountTB + amountTC /*+ amountTD + amountTE*/) );}function resetMouse(){  currentbar = 0;  $('#bars').css( 'cursor', 'default' );}$(document).mouseup(function(event){  if (currentbar > 0){    var position = $('#bars').position();    topbars = position.top;		var curTop = event.pageY    topbars = topbars + 29		if (curTop < topbars){		  curTop = topbars;		}    if ((100 - (((curTop - topbars) / 400) * 100) > barmax[currentbar])){      setNewTops(currentbar, barmax[currentbar]);    }    else {    //      log(Math.round(100 - (((curTop - topbars) / 400) * 100)));      setNewTops(currentbar, Math.round(100 - (((curTop - topbars) / 400) * 100)));    }  }  resetMouse();}); $(document).mousemove(function(event){  if (currentbar > 0){//alert(currentbar);    var position = $('#bars').position();    topbars = position.top;		var curTop = event.pageY    topbars = topbars + 29		if (curTop < topbars){		  curTop = topbars;		}    if ((100 - (((curTop - topbars) / 400) * 100) > barmax[currentbar])){      setNewTops(currentbar, barmax[currentbar]);    }    else {          setNewTops(currentbar, Math.round(100 - (((curTop - topbars) / 400) * 100)));    }  }//  resetMouse();}); $(document).mousedown(function(event){  currentbar = 0;  var curTop = event.pageY  var bottompos = $(bars).position().top + $(bars).height() - 12;  var toppos = $(bars).position().top;  if (curTop > bottompos){  }  else if (curTop < toppos){  }  else {//alert(curTop  + ':' + $(bars).position().top);		var curX = event.pageX    var leftpos = $(bars).position().left;		if (curX > leftpos + 120 && curX < leftpos + 200){		  currentbar = 1;		}		if (curX > leftpos + 230 && curX < leftpos + 310){		  currentbar = 2;		}		if (curX > leftpos + 340 && curX < leftpos + 420){		  currentbar = 3;		}		if (curX > leftpos + 450 && curX < leftpos + 530){		  currentbar = 4;		}		if (curX > leftpos + 560 && curX < leftpos + 640){		  currentbar = 5;		}  }});/*$( '#canvas' ).mouseup(function(event) {  if (currentbar > 0){		var curTop = event.clientY;		if (curTop < topbars){		  curTop = topbars;		}    setNewTops(currentbar, 100 - (((curTop - topbars) / 400) * 100));  }  resetMouse();});*//*$('#bar1').mouseup(function(event){alert('mouseup');  if (currentbar > 0){		var curTop = event.clientY;		if (curTop < topbars){		  curTop = topbars;		}    setNewTops(currentbar, 100 - (((curTop - topbars) / 400) * 100));  }  resetMouse();});*/showBars();</script>";    $contentStr .= '<div id=amounttotal name=amounttotal style="display: none;" >$<input type=text id="t_amounttotal" size="5" ></div><div id=log name=log style="width:260px"></div></div>';//style="display: none;"//cent = 100// hight = 400// 1 cent = 4 px..    /*      <div id=amount1 name=amount1 style="position: absolute; top: 400px; left:40px; height:20px; width:100px;">$<input type=text id="t_amount1" size="5"></div>      <div id=amount2 name=amount2 style="position: absolute; top: 400px; left:160px; height:20px; width:100px;">$<input type=text id="t_amount2" size="5"></div>      <div id=amount3 name=amount3 style="position: absolute; top: 400px; left:280px; height:20px; width:100px;">$<input type=text id="t_amount3" size="5"></div>      <div id=amount4 name=amount4 style="position: absolute; top: 400px; left:400px; height:20px; width:100px;">$<input type=text id="t_amount4" size="5"></div>      <div id=amount5 name=amount5 style="position: absolute; top: 400px; left:520px; height:20px; width:100px;">$<input type=text id="t_amount5" size="5"></div>     */// background-color:#FFFFCC;//<tr><td><i>Shares</i></td><td align=center><div id='sharesA'></div></td><td align=center><div id='sharesB'></div></td><td align=center><div id='sharesC'></div></td><td align=center><div id='sharesD'></div></td><td align=center><div id='sharesE'></div></td></tr>    return $contentStr;}function storeLogExperiment($variablename) {    if (startsWith($variablename, 'experiment_leandro')) {        $logfieldname = 'log_' . $variablename;        $logvalue = loadvar(str_replace(']', '}', str_replace('[', '{', $logfieldname)));        $index = substr($variablename, strpos($variablename, '['));        global $engine;        $engine->setAnswer($logfieldname, $logvalue);    }}function getUAS3Preload($cnt) {//10017492:1    global $db, $engine;    $query = "select * from uas3_preload where prim_key='" . $engine->getPrimaryKey() . "' and budget_order='" . $cnt . "'";    // testing only bart    $query = "select * from uas3_preload where prim_key='10017492:1' and budget_order='" . $cnt . "'";    // end testing only bart    $res = $db->selectQuery($query);    if ($res) {        if ($db->getNumberOfRows($res) > 0) {            while ($row = $db->getRow($res)) {                $engine->setAnswer('treatment_arm_1[' . $cnt . ']', $row['treatment_arm_1']);                $engine->setAnswer('treatment_arm_2[' . $cnt . ']', $row['treatment_arm_2']);                $engine->setAnswer('treatment_arm_3[' . $cnt . ']', $row['treatment_arm_3']);                $engine->setAnswer('treatment_arm_4[' . $cnt . ']', $row['treatment_arm_4']);                $engine->setAnswer('endowment[' . $cnt . ']', $row['endowment']);                $engine->setAnswer('outside_option[' . $cnt . ']', $row['outside_option']);                $engine->setAnswer('price_A[' . $cnt . ']', $row['price_A']);                $engine->setAnswer('price_B[' . $cnt . ']', $row['price_B']);                $engine->setAnswer('price_C[' . $cnt . ']', $row['price_C']);                $engine->setAnswer('price_D[' . $cnt . ']', $row['price_D']);                $engine->setAnswer('price_E[' . $cnt . ']', $row['price_E']);                $engine->setAnswer('payout_heads_A[' . $cnt . ']', $row['payout_heads_A']);                $engine->setAnswer('payout_heads_B[' . $cnt . ']', $row['payout_heads_B']);                $engine->setAnswer('payout_heads_C[' . $cnt . ']', $row['payout_heads_C']);                $engine->setAnswer('payout_heads_D[' . $cnt . ']', $row['payout_heads_D']);                $engine->setAnswer('payout_heads_E[' . $cnt . ']', $row['payout_heads_E']);                $engine->setAnswer('payout_tails_A[' . $cnt . ']', $row['payout_tails_A']);                $engine->setAnswer('payout_tails_B[' . $cnt . ']', $row['payout_tails_B']);                $engine->setAnswer('payout_tails_C[' . $cnt . ']', $row['payout_tails_C']);                $engine->setAnswer('payout_tails_D[' . $cnt . ']', $row['payout_tails_D']);                $engine->setAnswer('payout_tails_E[' . $cnt . ']', $row['payout_tails_E']);                $engine->setAnswer('default_A[' . $cnt . ']', $row['default_A']);                $engine->setAnswer('default_B[' . $cnt . ']', $row['default_B']);                $engine->setAnswer('default_C[' . $cnt . ']', $row['default_C']);                $engine->setAnswer('default_D[' . $cnt . ']', $row['default_D']);                $engine->setAnswer('default_E[' . $cnt . ']', $row['default_E']);            }        }    }}function getFromSurvey($fieldname, $default = '') {    global $engine;    $val = $engine->getAnswer($fieldname);    return $val;}?>